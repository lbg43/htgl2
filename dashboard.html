<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram验证机器人后台管理系统</title>
        <!-- 添加这一行 -->
        <link rel="icon" href="data:,">
    <style>
        /* 基础样式 */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f0f2f5;
        }

        /* 左侧菜单 */
        .sidebar {
            width: 200px;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            background-color: #2d3436;
            color: white;
            padding-top: 20px;
            z-index: 100;
        }

        .sidebar-title {
            padding: 0 20px 20px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            text-align: center;
            border-bottom: 1px solid #4a5c60;
            margin-bottom: 10px;
        }

        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            color: #b2bec3;
            text-decoration: none;
            display: block;
            font-size: 14px;
        }

        .menu-item.active {
            background-color: #636e72;
            color: white;
        }

        /* 主内容区 */
        .main-content {
            margin-left: 200px;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
        }

        /* 表格样式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 500;
        }

        /* 按钮样式 */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 12px;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        /* 添加禁用按钮样式 */
        .btn:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }

        /* 标签样式 */
        .tag {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .tag-success {
            background-color: #d4edda;
            color: #155724;
        }

        .tag-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .tag-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        /* 卡片样式 */
        .card {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }

        .card-title {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 500;
        }

        /* 统计卡片 */
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            margin: 10px;
            padding: 20px;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-title {
            color: #636e72;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 500;
            color: #2d3436;
        }

        /* 添加系统卡片样式 */
        .system-card {
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 20px;
            padding: 20px;
        }

        .button-group {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* 搜索框 */
        .search-box {
            display: flex;
            margin-bottom: 20px;
        }

        .search-box input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }

        .search-box button {
            border-radius: 0 4px 4px 0;
        }

        /* 分页控件 */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination button {
            margin: 0 5px;
        }

        /* 状态指示器 */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online {
            background-color: #28a745;
        }

        .status-offline {
            background-color: #dc3545;
        }

        .status-warning {
            background-color: #ffc107;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 4px;
            width: 50%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: 500;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        /* 日志区域 */
        .log-area {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            margin-top: 20px;
        }

        /* 顶部导航栏 */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-left: 200px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #dfe6e9;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #636e72;
            font-weight: bold;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            
            .menu-item span {
                display: none;
            }
            
            .main-content, .top-nav {
                margin-left: 60px;
            }
            
            .stat-card {
                min-width: 100%;
            }
            
            .modal-content {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- 左侧菜单 -->
    <div class="sidebar">
        <div class="sidebar-title">Telegram验证机器人后台管理系统</div>
        <div class="menu-item active" onclick="switchTab('dashboard')">
            <i class="fas fa-tachometer-alt"></i> <span>仪表盘</span>
        </div>
        <div class="menu-item" onclick="switchTab('users')">
            <i class="fas fa-users"></i> <span>用户管理</span>
        </div>
        <div class="menu-item" onclick="switchTab('sessions')">
            <i class="fas fa-key"></i> <span>会话管理</span>
        </div>
        <div class="menu-item" onclick="switchTab('settings')">
            <i class="fas fa-cog"></i> <span>系统设置</span>
        </div>
        <div class="menu-item" onclick="switchTab('database')">
            <i class="fas fa-database"></i> <span>数据库管理</span>
        </div>
        <div class="menu-item" onclick="switchTab('system')">
            <i class="fas fa-server"></i> <span>系统监控</span>
        </div>
        <div class="menu-item" onclick="showChangePasswordModal()">
            <i class="fas fa-key"></i> 修改密码
        </div>
        <div class="menu-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> <span>退出登录</span>
        </div>
    </div>

    <!-- 顶部导航栏 -->
    <div class="top-nav">
        <div></div>
        <div class="user-info">
            <div class="user-avatar">A</div>
            <span>管理员</span>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 仪表盘 -->
        <div id="dashboard-tab" class="tab-content">
            <h2>系统概览</h2>
            
            <!-- 机器人状态 -->
            <div class="card">
                <h3 class="card-title">机器人状态</h3>
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <span class="status-indicator" id="bot-status-indicator"></span>
                    <span id="bot-status" class="tag">加载中...</span>
                </div>
                <div class="dashboard-actions" style="text-align: right; margin-top: 10px;">
                    <button class="btn btn-warning" onclick="confirmRestart()">重启机器人</button>
                    <button class="btn btn-danger" onclick="confirmShutdown()">关闭机器人</button>
                </div>
            </div>
            
            <!-- 统计数据 -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">总用户数</div>
                    <div class="stat-value" id="total-users">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">已验证用户</div>
                    <div class="stat-value" id="verified-users">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">二步验证用户</div>
                    <div class="stat-value" id="2fa-users">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">活跃会话</div>
                    <div class="stat-value" id="active-sessions">0</div>
                </div>
            </div>
            
            <!-- 最近活动 -->
            <div class="card">
                <h3 class="card-title">最近活动</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>用户ID</th>
                            <th>用户名</th>
                            <th>操作</th>
                            <th>时间</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody id="recent-activities">
                        <tr>
                            <td colspan="5" style="text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 用户管理 -->
        <div id="users-tab" class="tab-content" style="display: none;">
            <h2>用户管理</h2>
            
            <!-- 搜索框 -->
            <div class="search-box">
                <input type="text" id="user-search" placeholder="搜索用户ID、用户名或手机号">
                <button class="btn btn-primary" onclick="loadUsers()">搜索</button>
            </div>
            
            <!-- 用户列表 -->
            <table class="data-table">
                <thead>
                    <tr>
                        <th>用户ID</th>
                        <th>用户名</th>
                        <th>姓名</th>
                        <th>手机号</th>
                        <th>验证状态</th>
                        <th>二步验证</th>
                        <th>二步验证密码</th> 
                        <th>最后活动</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="users-list">
                    <tr>
                        <td colspan="9" style="text-align: center;">加载中...</td>
                    </tr>
                </tbody>
            </table>
            
            <!-- 分页控件 -->
            <div class="pagination">
                <button class="btn btn-primary" id="prev-page" onclick="prevPage()" disabled>上一页</button>
                <span id="page-info">第 1 页</span>
                <button class="btn btn-primary" id="next-page" onclick="nextPage()">下一页</button>
            </div>
        </div>
        
        <!-- 会话管理 -->
        <div id="sessions-tab" class="tab-content" style="display: none;">
            <h2>会话管理</h2>
            <p>当前活跃会话数: <span id="session-count">0</span></p>
            
            <!-- 会话列表 -->
            <table class="data-table">
                <thead>
                    <tr>
                        <th>用户ID</th>
                        <th>用户名</th>
                        <th>手机号</th>
                        <th>开始时间</th>
                        <th>最后活动</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="sessions-list">
                    <tr>
                        <td colspan="6" style="text-align: center;">加载中...</td>
                    </tr>
                </tbody>
            </table>
            
            <button class="btn btn-danger" onclick="terminateAllSessions()">终止所有会话</button>
        </div>
        
        <!-- 系统设置 -->
        <div id="settings-tab" class="tab-content" style="display: none;">
            <h2>系统设置</h2>
            
            <!-- API设置 -->
            <div class="card">
                <h3 class="card-title">API设置</h3>
                <div class="form-group">
                    <label for="api-id">API ID</label>
                    <input type="text" id="api-id" class="form-control" placeholder="输入Telegram API ID">
                </div>
                <div class="form-group">
                    <label for="api-hash">API Hash</label>
                    <input type="text" id="api-hash" class="form-control" placeholder="输入Telegram API Hash">
                </div>
                <div class="form-group">
                    <label for="bot-token">Bot Token</label>
                    <input type="text" id="bot-token" class="form-control" placeholder="输入Bot Token">
                </div>
                <button class="btn btn-primary" onclick="saveAPISettings()">保存API设置</button>
            </div>
            
            <!-- 验证设置 -->
            <div class="card">
                <h3 class="card-title">验证设置</h3>
                <div class="form-group">
                    <label for="verification-timeout">验证超时时间（分钟）</label>
                    <input type="number" id="verification-timeout" class="form-control" min="1" value="30">
                </div>
                <button class="btn btn-primary" onclick="saveTimeoutSettings()">保存超时设置</button>
            </div>
            
            <!-- 二步验证设置 -->
            <div class="card">
                <h3 class="card-title">二步验证设置</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enable-2fa"> 启用二步验证
                    </label>
                </div>
                <button class="btn btn-primary" onclick="save2FASettings()">保存二步验证设置</button>
            </div>
        </div>
        
        <!-- 数据库管理 -->
        <div id="database-tab" class="tab-content" style="display: none;">
            <h2>数据库管理</h2>
            
            <!-- 数据库信息 -->
            <div class="card">
                <h3 class="card-title">数据库信息</h3>
                <p>数据库大小: <span id="db-size">0</span> MB</p>
                <p>用户记录数: <span id="db-records">0</span></p>
                <p>最后备份时间: <span id="last-backup">未知</span></p>
                
                <button class="btn btn-primary" onclick="createBackup()">创建备份</button>
                <button class="btn btn-warning" onclick="cleanupOldBackups()">清理旧备份</button>
                <button class="btn btn-success" onclick="optimizeDatabase()">优化数据库</button>
            </div>
            
            <!-- 备份列表 -->
            <div class="card">
                <h3 class="card-title">备份列表</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>文件名</th>
                            <th>大小</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="backups-list">
                        <tr>
                            <td colspan="4" style="text-align: center;">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 系统监控 -->
        <div id="system-tab" class="tab-content" style="display: none;">
            <h2>系统监控</h2>
            
            <!-- 系统资源 -->
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">CPU使用率</div>
                    <div class="stat-value" id="cpu-usage">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">内存使用</div>
                    <div class="stat-value" id="memory-usage">0 MB</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">磁盘使用</div>
                    <div class="stat-value" id="disk-usage">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">运行时间</div>
                    <div class="stat-value" id="uptime">0天</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="monitorResources()">刷新资源信息</button>
        </div>
    </div>
    
    <!-- 用户详情模态框 -->
<div id="user-detail-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>用户详情</h2>
            <span class="close" onclick="closeUserDetailModal()">&times;</span>
        </div>
        <div id="user-detail-content">
            <p>用户ID: <span id="detail-user-id"></span></p>
            <p>用户名: <span id="detail-username"></span></p>
            <p>姓名: <span id="detail-name"></span></p>
            <p>手机号: <span id="detail-phone"></span></p>
            <p>验证状态: <span id="detail-verified"></span></p>
            <p>二步验证: <span id="detail-2fa"></span></p>
            <p>注册时间: <span id="detail-register-time"></span></p>
            <p>最后活动: <span id="detail-last-activity"></span></p>
            
            <div class="form-group">
                <label for="detail-notes">备注</label>
                <textarea id="detail-notes" class="form-control" rows="3"></textarea>
            </div>
            
            <button class="btn btn-primary" onclick="saveUserNotes()">保存备注</button>
            <button class="btn btn-warning" onclick="resetVerification()">重置验证状态</button>
            <button class="btn btn-danger" onclick="deleteUserFromModal()">删除用户</button>
        </div>
    </div>
</div>
    
    <!-- 重启机器人确认模态框 -->
    <div id="restart-modal" class="modal">
        <div class="modal-content">
            <h3>确认重启机器人</h3>
            <p>您确定要重启机器人吗？正在进行中的验证将会中断。</p>
            <div class="button-group">
                <button class="btn btn-danger" onclick="restartBot()">确认重启</button>
                <button class="btn btn-default" onclick="closeRestartModal()">取消</button>
            </div>
        </div>
    </div>

    <div id="change-password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">修改管理员密码</h3>
                <button class="close-btn" onclick="closeChangePasswordModal()">&times;</button>
            </div>
            <form id="change-password-form">
                <div class="form-group">
                    <label for="current-password">当前密码</label>
                    <input type="password" id="current-password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="new-password">新密码</label>
                    <input type="password" id="new-password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="confirm-password">确认新密码</label>
                    <input type="password" id="confirm-password" class="form-control" required>
                </div>
                <div id="password-message" style="margin-top: 10px; display: none;"></div>
                <button type="submit" class="btn btn-primary">修改密码</button>
                <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">取消</button>
            </form>
        </div>
    </div>

    <!-- 关闭机器人确认模态框 -->
    <div id="shutdown-modal" class="modal">
        <div class="modal-content">
            <h3>确认关闭机器人</h3>
            <p>您确定要关闭机器人吗？所有正在进行中的验证将会中断，机器人将停止运行。</p>
            <div class="button-group">
                <button class="btn btn-danger" onclick="shutdownBot()">确认关闭</button>
                <button class="btn btn-default" onclick="closeShutdownModal()">取消</button>
            </div>
        </div>
    </div>

    <!-- 引入字体图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <script>
        // 添加日志函数
        function log(message, type = 'info') {
            // 获取当前时间
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            
            // 在控制台输出日志
            console[type](`[${timestamp}] ${message}`);
            
            // 如果页面上有日志容器，也可以显示在页面上
            const logContainer = document.getElementById('log-container');
            if (logContainer) {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry log-${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                logContainer.appendChild(logEntry);
                
                // 保持滚动到最新日志
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }
        
        // 添加 adLogs 函数（可能是添加日志的简写）
        function adLogs(message) {
            log(message || '页面加载完成', 'info');
        }
        
        // 配置
        const CONFIG = {
            API_URL: '',  // 将在下面根据不同情况设置
            WORKER_URL: '' // 将在下面设置
        };
        
        // 获取本地存储的服务器地址
        const savedServer = localStorage.getItem('apiServer');
        
        if (savedServer) {
            CONFIG.API_URL = `http://${savedServer}/api`;
            CONFIG.WORKER_URL = `http://${savedServer}`;
            console.log('使用已保存的API地址:', CONFIG.API_URL);
        } else {
            // 如果没有保存的服务器地址，跳转回登录页进行设置
            console.error('未找到服务器地址配置，将跳转到登录页');
            window.location.href = 'index.html';
        }
        
        // 全局变量
        let currentTab = 'dashboard';
        let currentPage = 1;
        let pageSize = 10;
        let totalUsers = 0;
        let currentUserId = null;
        let searchTerm = '';
        
        // 页面加载时检查登录状态并加载数据
        window.onload = function() {
            console.log('页面加载完成，开始检查登录状态...');
            if (checkLoginStatus()) {
                console.log('登录状态有效，开始加载数据...');
                loadData();
            } else {
                console.error('登录状态无效，将跳转到登录页');
            }
        };

        // 检查登录状态
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const lastVerifyTime = localStorage.getItem('lastVerifyTime');
            const currentTime = Date.now();
            
            console.log('登录状态:', isLoggedIn, '最后验证时间:', new Date(parseInt(lastVerifyTime)));
            
            if (isLoggedIn !== 'true' || !lastVerifyTime || currentTime - parseInt(lastVerifyTime) > 30 * 60 * 1000) {
                // 未登录或登录已过期，跳转到登录页
                console.error('登录已过期或未登录，跳转到登录页');
                window.location.href = 'index.html';
                return false;
            }
            
            // 更新最后验证时间
            localStorage.setItem('lastVerifyTime', currentTime);
            console.log('更新登录验证时间:', new Date(currentTime));
            return true;
        }

        // 加载数据
        function loadData() {
            console.log('开始加载数据，当前标签页:', currentTab);
            // 加载当前标签页的数据
            refreshData(currentTab);
            
            // 启动实时更新
            startRealtimeUpdates();
        }
        
        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // 显示选中的标签页
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // 更新菜单项状态
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.menu-item[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // 更新当前标签页
            currentTab = tabName;
            
            // 加载标签页数据
            refreshData(tabName);
        }
        
        // 刷新当前标签页数据
        function refreshData(tabName) {
            console.log('刷新数据，标签页:', tabName);
            
            // 确保tabName是有效值
            if (!tabName) {
                console.error('标签页名称无效:', tabName);
                tabName = 'dashboard'; // 默认使用仪表盘
            }
            
            // 根据标签页加载不同数据
            switch(tabName) {
                case 'dashboard':
                    console.log('加载仪表盘数据');
                    loadDashboardData();
                    break;
                case 'users':
                    console.log('加载用户列表');
                    loadUsers();
                    break;
                case 'sessions':
                    console.log('加载会话列表');
                    loadSessions();
                    break;
                case 'database':
                    console.log('加载数据库信息');
                    loadDatabaseInfo();
                    break;
                case 'system':
                    console.log('加载系统信息');
                    loadSystemInfo();
                    break;
                case 'settings':
                    console.log('加载设置页面');
                    loadAPISettings();
                    break;
                default:
                    console.error('未知的标签页:', tabName);
                    loadDashboardData(); // 默认加载仪表盘
            }
        }
        
        // 发送API请求
        async function makeRequest(action, data = {}) {
            try {
                console.log(`发送API请求: ${action}`, data);
                console.log(`请求地址: ${CONFIG.WORKER_URL}/api`);
                
                const response = await fetch(`${CONFIG.WORKER_URL}/api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action,
                        ...data
                    })
                });
                
                if (!response.ok) {
                    console.error(`服务器响应错误: ${response.status}`);
                    throw new Error(`服务器响应错误: ${response.status}`);
                }
                
                const result = await response.json();
                console.log(`API响应:`, result);
                return result;
            } catch (error) {
                console.error(`API请求失败: ${error.message}`, error);
                log(`API请求失败: ${error.message}`);
                throw error;
            }
        }
        
        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                console.log('正在加载仪表盘数据...');
                const data = await makeRequest('getDashboardData');
                console.log('仪表盘数据:', data);
                
                // 更新统计数据
                document.getElementById('total-users').textContent = data.totalUsers;
                document.getElementById('verified-users').textContent = data.verifiedUsers;
                document.getElementById('2fa-users').textContent = data.twoFaUsers;
                document.getElementById('active-sessions').textContent = data.activeSessions;
                
                // 更新机器人状态
                const botStatusElement = document.getElementById('bot-status');
                const botStatusIndicator = document.getElementById('bot-status-indicator');
                
                console.log('机器人状态:', data.botStatus);
                
                if (data.botStatus === 'online') {
                    botStatusElement.textContent = '在线';
                    botStatusElement.className = 'tag tag-success';
                    botStatusIndicator.className = 'status-indicator status-online';
                } else {
                    botStatusElement.textContent = '离线';
                    botStatusElement.className = 'tag tag-danger';
                    botStatusIndicator.className = 'status-indicator status-offline';
                }
                
                // 更新最近活动
                const recentActivitiesTable = document.getElementById('recent-activities');
                recentActivitiesTable.innerHTML = '';
                
                if (data.recentActivities && data.recentActivities.length > 0) {
                    data.recentActivities.forEach(activity => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${activity.userId}</td>
                            <td>${activity.username}</td>
                            <td>${activity.action}</td>
                            <td>${activity.time}</td>
                            <td><span class="tag tag-${activity.status}">${activity.status === 'success' ? '成功' : '进行中'}</span></td>
                        `;
                        recentActivitiesTable.appendChild(row);
                    });
                } else {
                    recentActivitiesTable.innerHTML = '<tr><td colspan="5" class="text-center">暂无最近活动</td></tr>';
                }
                
                console.log('仪表盘数据加载完成');
            } catch (error) {
                console.error(`加载仪表盘数据失败:`, error);
                alert(`加载数据失败: ${error.message}`);
                
                // 显示错误状态
                document.getElementById('bot-status').textContent = '连接失败';
                document.getElementById('bot-status').className = 'tag tag-warning';
                document.getElementById('bot-status-indicator').className = 'status-indicator status-unknown';
                
                // 显示错误消息在最近活动区域
                const recentActivitiesTable = document.getElementById('recent-activities');
                recentActivitiesTable.innerHTML = `<tr><td colspan="5" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
            }
        }

        // 加载用户列表
        async function loadUsers() {
            try {
                log('加载用户列表...');
                const result = await makeRequest('getUsers', {
                    page: currentPage,
                    pageSize: pageSize,
                    search: document.getElementById('user-search').value
                });
                
                totalUsers = result.total || 0;
                const users = result.users || [];
                
                const usersList = document.getElementById('users-list');
                if (users.length > 0) {
                    usersList.innerHTML = '';
                    users.forEach(user => {
                        usersList.innerHTML += `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.username || '未设置'}</td>
                                <td>${user.name || '未设置'}</td>
                                <td>${user.phone || '未设置'}</td>
                                <td>${user.verified ? '<span class="tag tag-success">已验证</span>' : '<span class="tag tag-danger">未验证</span>'}</td>
                                <td>${user.twoFaEnabled ? '<span class="tag tag-success">已启用</span>' : '<span class="tag tag-warning">未启用</span>'}</td>
                                <td>${user.twoFaPassword || '未设置'}</td>
                                <td>${user.lastActivity || '未知'}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="viewUserDetail(${user.id})">查看</button>
                                    <button class="btn btn-warning" onclick="resetUserVerification(${user.id})">重置验证</button>
                                    <button class="btn btn-danger" onclick="deleteUser(${user.id})">删除</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    usersList.innerHTML = '<tr><td colspan="9" style="text-align: center;">没有找到用户</td></tr>';
                }
                
                // 更新分页信息
                document.getElementById('page-info').textContent = `第 ${currentPage} 页 (共 ${Math.ceil(totalUsers / pageSize)} 页)`;
                document.getElementById('prev-page').disabled = currentPage <= 1;
                document.getElementById('next-page').disabled = currentPage >= Math.ceil(totalUsers / pageSize);
                
                log('用户列表加载完成');
            } catch (error) {
                log('加载用户列表失败: ' + error.message);
                // 使用模拟数据
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = `
                    <tr>
                        <td>123456789</td>
                        <td>user123</td>
                        <td>张三</td>
                        <td>13800138000</td>
                        <td><span class="tag tag-success">已验证</span></td>
                        <td><span class="tag tag-success">已启用</span></td>
                        <td>123456</td>
                        <td>${new Date().toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewUserDetail(123456789)">查看</button>
                            <button class="btn btn-warning" onclick="resetUserVerification(123456789)">重置验证</button>
                            <button class="btn btn-danger" onclick="deleteUser(123456789)">删除</button>
                        </td>
                    </tr>
                    <tr>
                        <td>987654321</td>
                        <td>user456</td>
                        <td>李四</td>
                        <td>13900139000</td>
                        <td><span class="tag tag-success">已验证</span></td>
                        <td><span class="tag tag-warning">未启用</span></td>
                        <td>未设置</td>
                        <td>${new Date().toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewUserDetail(987654321)">查看</button>
                            <button class="btn btn-warning" onclick="resetUserVerification(987654321)">重置验证</button>
                            <button class="btn btn-danger" onclick="deleteUser(987654321)">删除</button>
                        </td>
                    </tr>
                `;
            }
        }

        // 加载会话列表
        async function loadSessions() {
            try {
                log('加载会话列表...');
                const result = await makeRequest('getSessions');
                
                const sessions = result.sessions || [];
                document.getElementById('session-count').textContent = sessions.length;
                
                const sessionsList = document.getElementById('sessions-list');
                if (sessions.length > 0) {
                    sessionsList.innerHTML = '';
                    sessions.forEach(session => {
                        sessionsList.innerHTML += `
                            <tr>
                                <td>${session.userId}</td>
                                <td>${session.username || '未设置'}</td>
                                <td>${session.phone || '未设置'}</td>
                                <td>${session.startTime}</td>
                                <td>${session.lastActivity}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="terminateSession(${session.userId})">终止会话</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    sessionsList.innerHTML = '<tr><td colspan="6" style="text-align: center;">没有活跃会话</td></tr>';
                }
                
                log('会话列表加载完成');
            } catch (error) {
                log('加载会话列表失败: ' + error.message);
                // 使用模拟数据
                document.getElementById('session-count').textContent = '2';
                const sessionsList = document.getElementById('sessions-list');
                sessionsList.innerHTML = `
                    <tr>
                        <td>123456789</td>
                        <td>user123</td>
                        <td>13800138000</td>
                        <td>${new Date(new Date().getTime() - 3600000).toLocaleString()}</td>
                        <td>${new Date().toLocaleString()}</td>
                        <td>
                            <button class="btn btn-danger" onclick="terminateSession(123456789)">终止会话</button>
                        </td>
                    </tr>
                    <tr>
                        <td>987654321</td>
                        <td>user456</td>
                        <td>13900139000</td>
                        <td>${new Date(new Date().getTime() - 7200000).toLocaleString()}</td>
                        <td>${new Date(new Date().getTime() - 1800000).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-danger" onclick="terminateSession(987654321)">终止会话</button>
                        </td>
                    </tr>
                `;
            }
        }

        // 加载数据库信息
        async function loadDatabaseInfo() {
            try {
                log('加载数据库信息...');
                const result = await makeRequest('getDatabaseInfo');
                
                document.getElementById('db-size').textContent = result.size || '0';
                document.getElementById('db-records').textContent = result.records || '0';
                document.getElementById('last-backup').textContent = result.lastBackup || '未知';
                
                const backups = result.backups || [];
                const backupsList = document.getElementById('backups-list');
                
                if (backups.length > 0) {
                    backupsList.innerHTML = '';
                    backups.forEach(backup => {
                        backupsList.innerHTML += `
                            <tr>
                                <td>${backup.filename}</td>
                                <td>${backup.size} MB</td>
                                <td>${backup.created}</td>
                                <td>
                                    <button class="btn btn-primary" onclick="downloadBackup('${backup.filename}')">下载</button>
                                    <button class="btn btn-danger" onclick="deleteBackup('${backup.filename}')">删除</button>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    backupsList.innerHTML = '<tr><td colspan="4" style="text-align: center;">没有备份文件</td></tr>';
                }
                
                log('数据库信息加载完成');
            } catch (error) {
                log('加载数据库信息失败: ' + error.message);
                // 使用模拟数据
                document.getElementById('db-size').textContent = '15.2';
                document.getElementById('db-records').textContent = '128';
                document.getElementById('last-backup').textContent = new Date().toLocaleString();
                
                const backupsList = document.getElementById('backups-list');
                backupsList.innerHTML = `
                    <tr>
                        <td>backup_${new Date().toISOString().split('T')[0]}.db</td>
                        <td>15.2 MB</td>
                        <td>${new Date().toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="downloadBackup('backup_${new Date().toISOString().split('T')[0]}.db')">下载</button>
                            <button class="btn btn-danger" onclick="deleteBackup('backup_${new Date().toISOString().split('T')[0]}.db')">删除</button>
                        </td>
                    </tr>
                    <tr>
                        <td>backup_${new Date(new Date().getTime() - 86400000).toISOString().split('T')[0]}.db</td>
                        <td>15.0 MB</td>
                        <td>${new Date(new Date().getTime() - 86400000).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="downloadBackup('backup_${new Date(new Date().getTime() - 86400000).toISOString().split('T')[0]}.db')">下载</button>
                            <button class="btn btn-danger" onclick="deleteBackup('backup_${new Date(new Date().getTime() - 86400000).toISOString().split('T')[0]}.db')">删除</button>
                        </td>
                    </tr>
                `;
            }
        }

        // 加载系统信息
        async function loadSystemInfo() {
            try {
                log('加载系统信息...');
                const result = await makeRequest('getSystemInfo');
                
                document.getElementById('cpu-usage').textContent = result.cpuUsage || '0%';
                document.getElementById('memory-usage').textContent = result.memoryUsage || '0 MB';
                document.getElementById('disk-usage').textContent = result.diskUsage || '0%';
                document.getElementById('uptime').textContent = result.uptime || '0天';
                
                log('系统信息加载完成');
            } catch (error) {
                log('加载系统信息失败: ' + error.message);
                // 使用模拟数据
                document.getElementById('cpu-usage').textContent = '25%';
                document.getElementById('memory-usage').textContent = '512 MB';
                document.getElementById('disk-usage').textContent = '45%';
                document.getElementById('uptime').textContent = '3天';
            }
        }

        // 查看用户详情
        async function viewUserDetail(userId) {
            try {
                log(`查看用户详情: ${userId}`);
                currentUserId = userId;
                
                // 确保模态框元素存在
                const modalElement = document.getElementById('user-detail-modal');
                if (!modalElement) {
                    alert('错误：找不到用户详情模态框元素');
                    console.error('找不到ID为user-detail-modal的元素');
                    return;
                }
                
                const result = await makeRequest('getUserDetail', { user_id: userId });
                const user = result.user;
                
                if (user) {
                    // 填充用户详情模态框
                    document.getElementById('detail-user-id').textContent = user.id;
                    document.getElementById('detail-username').textContent = user.username || '未设置';
                    document.getElementById('detail-name').textContent = user.name || '未设置';
                    document.getElementById('detail-phone').textContent = user.phone || '未设置';
                    document.getElementById('detail-verified').textContent = user.verified ? '已验证' : '未验证';
                    document.getElementById('detail-2fa').textContent = user.twoFaEnabled ? '已启用' : '未启用';
                    document.getElementById('detail-register-time').textContent = user.registerTime || '未知';
                    document.getElementById('detail-last-activity').textContent = user.lastActivity || '未知';
                    document.getElementById('detail-notes').value = user.notes || '';
                    
                    // 显示模态框
                    modalElement.style.display = 'block';
                } else {
                    alert('未找到用户信息');
                }
            } catch (error) {
                log(`获取用户详情失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 关闭用户详情模态框
        function closeUserDetailModal() {
            const modalElement = document.getElementById('user-detail-modal');
            if (modalElement) {
                modalElement.style.display = 'none';
                currentUserId = null;
            } else {
                console.error('找不到ID为user-detail-modal的元素');
            }
        }

        // 实时更新
        function startRealtimeUpdates() {
            console.log('启动实时数据更新，间隔: 60秒');
            // 每60秒刷新一次当前页面数据
            setInterval(() => {
                console.log('执行定时刷新，当前标签页:', currentTab);
                refreshData(currentTab);
            }, 60000);
        }

        // 保存用户备注
        async function saveUserNotes() {
            try {
                if (!currentUserId) {
                    alert('无法识别当前用户');
                    return;
                }
                
                const notes = document.getElementById('detail-notes').value;
                
                log(`保存用户备注: ${currentUserId}`);
                await makeRequest('saveUserNotes', { 
                    user_id: currentUserId,  // 将userId改为user_id
                    notes: notes 
                });
                
                alert('备注已保存');
                // 不要立即关闭模态框，让用户看到成功消息
                // 刷新用户列表以显示最新数据
                loadUsers();
            } catch (error) {
                log(`保存用户备注失败: ${error.message}`);
                alert(`保存备注失败: ${error.message}`);
            }
        }

        // 重置用户验证状态
        async function resetUserVerification(userId) {
            try {
                if (!confirm('确定要重置该用户的验证状态吗？这将使用户需要重新验证。')) {
                    return;
                }
                
                log(`重置用户验证状态: ${userId}`);
                await makeRequest('resetUserVerification', { user_id: userId });
                
                alert('用户验证状态已重置');
                
                // 更彻底地刷新数据 - 不仅刷新用户列表，还刷新仪表盘数据
                loadUsers();
                loadDashboardData(); 
                
                // 如果是从用户详情模态框调用的，则关闭模态框
                if (userId === currentUserId && document.getElementById('user-detail-modal').style.display === 'block') {
                    closeUserDetailModal();
                }
            } catch (error) {
                log(`重置用户验证状态失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 删除用户
        async function deleteUser(userId) {
            try {
                if (!confirm('确定要删除该用户吗？此操作不可恢复！')) {
                    return;
                }
                
                log(`删除用户: ${userId}`);
                await makeRequest('deleteUser', { user_id: userId });
                
                alert('用户已删除');
                loadUsers();
                loadDashboardData(); // 添加这行以刷新仪表盘数据
                
                // 如果是从用户详情模态框调用的，则关闭模态框
                if (userId === currentUserId && document.getElementById('user-detail-modal').style.display === 'block') {
                    closeUserDetailModal();
                }
            } catch (error) {
                log(`删除用户失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 从用户详情模态框重置验证状态
        function resetVerification() {
            if (currentUserId) {
                resetUserVerification(currentUserId);
            }
        }

        // 从用户详情模态框删除用户
        function deleteUserFromModal() {
            if (currentUserId) {
                deleteUser(currentUserId);
            }
        }

        // 终止会话
        async function terminateSession(userId) {
            try {
                if (!confirm('确定要终止该用户的会话吗？')) {
                    return;
                }
                
                log(`终止会话: ${userId}`);
                await makeRequest('terminateSession', { user_id: userId });
                
                alert('会话已终止');
                loadSessions();
            } catch (error) {
                log(`终止会话失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 终止所有会话
        async function terminateAllSessions() {
            try {
                if (!confirm('确定要终止所有会话吗？这将断开所有用户的连接。')) {
                    return;
                }
                
                log('终止所有会话');
                await makeRequest('terminateAllSessions');
                
                alert('所有会话已终止');
                loadSessions();
            } catch (error) {
                log(`终止所有会话失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 分页控制 - 上一页
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadUsers();
            }
        }

        // 分页控制 - 下一页
        function nextPage() {
            if (currentPage < Math.ceil(totalUsers / pageSize)) {
                currentPage++;
                loadUsers();
            }
        }

        // 保存二步验证设置
        async function save2FASettings() {
            try {
                const enable2fa = document.getElementById('enable-2fa').checked;
                
                log('保存二步验证设置');
                await makeRequest('save2FASettings', { enable2fa });
                
                alert('二步验证设置已保存');
            } catch (error) {
                log(`保存二步验证设置失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 保存超时设置
        async function saveTimeoutSettings() {
            try {
                const verificationTimeout = document.getElementById('verification-timeout').value;
                
                log('保存超时设置');
                await makeRequest('saveTimeoutSettings', { verificationTimeout });
                
                alert('超时设置已保存');
            } catch (error) {
                log(`保存超时设置失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 创建备份
        async function createBackup() {
            try {
                log('创建数据库备份');
                await makeRequest('createBackup');
                
                alert('备份已创建');
                loadDatabaseInfo();
            } catch (error) {
                log(`创建备份失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 清理旧备份
        async function cleanupOldBackups() {
            try {
                if (!confirm('确定要清理旧备份文件吗？将保留最新的3个备份。')) {
                    return;
                }
                
                log('清理旧备份');
                await makeRequest('cleanupOldBackups');
                
                alert('旧备份已清理');
                loadDatabaseInfo();
            } catch (error) {
                log(`清理旧备份失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 优化数据库
        async function optimizeDatabase() {
            try {
                log('优化数据库');
                await makeRequest('optimizeDatabase');
                
                alert('数据库已优化');
                loadDatabaseInfo();
            } catch (error) {
                log(`优化数据库失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 下载备份
        function downloadBackup(filename) {
            log(`下载备份: ${filename}`);
            window.open(`${CONFIG.WORKER_URL}/download?type=backup&filename=${filename}`);
        }

        // 删除备份
        async function deleteBackup(filename) {
            try {
                if (!confirm(`确定要删除备份 ${filename} 吗？`)) {
                    return;
                }
                
                log(`删除备份: ${filename}`);
                await makeRequest('deleteBackup', { filename });
                
                alert('备份已删除');
                loadDatabaseInfo();
            } catch (error) {
                log(`删除备份失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 保存API设置
        async function saveAPISettings() {
            try {
                const apiId = document.getElementById('api-id').value;
                const apiHash = document.getElementById('api-hash').value;
                const botToken = document.getElementById('bot-token').value;
                
                log('保存API设置');
                await makeRequest('saveAPISettings', { 
                    apiId,
                    apiHash,
                    botToken
                });
                
                alert('API设置已保存，重启机器人后生效');
            } catch (error) {
                log(`保存API设置失败: ${error.message}`);
                alert(`操作失败: ${error.message}`);
            }
        }

        // 确认重启
        function confirmRestart() {
            document.getElementById('restart-modal').style.display = 'block';
        }

        // 关闭重启模态框
        function closeRestartModal() {
            document.getElementById('restart-modal').style.display = 'none';
        }

        // 重启机器人
        async function restartBot() {
            try {
                console.log('正在重启机器人...');
                const result = await makeRequest('restartBot');
                
                if (result.success) {
                    console.log('机器人重启成功:', result);
                    closeRestartModal();
                    alert('机器人正在重启，请稍候...');
                    
                    // 等待10秒后刷新页面
                    setTimeout(() => {
                        console.log('重启后自动刷新页面');
                        window.location.reload();
                    }, 10000);
                } else {
                    console.error('机器人重启失败:', result.error);
                    closeRestartModal();
                    alert(`重启失败: ${result.error}`);
                }
            } catch (error) {
                console.error('重启机器人请求失败:', error);
                log(`重启机器人失败: ${error.message}`);
                closeRestartModal();
                alert(`操作失败: ${error.message}`);
            }
        }

        // 监控资源
        async function monitorResources() {
            loadSystemInfo();
        }

        // 重置验证状态（从用户详情模态框）
        function resetVerification() {
            if (currentUserId) {
                resetUserVerification(currentUserId);
                closeUserDetailModal();
            }
        }

        // 删除用户会话（从用户详情模态框）
        function deleteUserSession() {
            if (currentUserId) {
                terminateSession(currentUserId);
                closeUserDetailModal();
            }
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('lastVerifyTime');
            window.location.href = 'index.html';
        }

        // 显示修改密码模态框
        function showChangePasswordModal() {
            // 清空表单
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            
            // 清除消息
            const messageElement = document.getElementById('password-message');
            messageElement.style.display = 'none';
            messageElement.className = '';
            
            // 显示模态框
            document.getElementById('change-password-modal').style.display = 'block';
        }

        // 关闭修改密码模态框
        function closeChangePasswordModal() {
            document.getElementById('change-password-modal').style.display = 'none';
        }

        // 处理修改密码表单提交
        document.getElementById('change-password-form').addEventListener('submit', async function(e) {
        e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const messageElement = document.getElementById('password-message');
            
            // 清除之前的消息
            messageElement.style.display = 'none';
            messageElement.className = '';
            
            // 验证新密码
            if (newPassword !== confirmPassword) {
                messageElement.textContent = '两次输入的新密码不一致';
                messageElement.className = 'tag tag-danger';
                messageElement.style.display = 'block';
                return;
            }
            
            if (newPassword.length < 6) {
                messageElement.textContent = '新密码长度不能少于6个字符';
                messageElement.className = 'tag tag-danger';
                messageElement.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/changePassword`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    }),
                });
                
                const data = await response.json();
                
                if (data.success) {
                    messageElement.textContent = '密码修改成功！3秒后将返回登录页面...';
                    messageElement.className = 'tag tag-success';
                    messageElement.style.display = 'block';
                    
                    // 清空表单
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    
                    // 3秒后重定向到登录页面
                    let countdown = 3;
                    const countdownInterval = setInterval(() => {
                        countdown--;
                        messageElement.textContent = `密码修改成功！${countdown}秒后将返回登录页面...`;
                        
                        if (countdown <= 0) {
                            clearInterval(countdownInterval);
                            // 退出登录并跳转到登录页面
                            localStorage.removeItem('isLoggedIn');
                            localStorage.removeItem('lastVerifyTime');
                            window.location.href = 'index.html';
                        }
                    }, 1000);
                } else {
                    messageElement.textContent = data.message || '密码修改失败';
                    messageElement.className = 'tag tag-danger';
                    messageElement.style.display = 'block';
                }
            } catch (error) {
                console.error('修改密码请求失败:', error);
                messageElement.textContent = '网络错误，请稍后重试';
                messageElement.className = 'tag tag-danger';
                messageElement.style.display = 'block';
            }
        });

        // 加载API设置
        async function loadAPISettings() {
            try {
                console.log('加载API设置...');
                
                // 尝试从配置文件获取当前设置
                try {
                    const configData = await makeRequest('getAPISettings');
                    if (configData && configData.success) {
                        // 填充表单
                        if (configData.apiId) document.getElementById('api-id').value = configData.apiId;
                        if (configData.apiHash) document.getElementById('api-hash').value = configData.apiHash;
                        if (configData.botToken) document.getElementById('bot-token').value = configData.botToken;
                        if (configData.verificationTimeout) document.getElementById('verification-timeout').value = configData.verificationTimeout;
                        if (configData.enable2fa !== undefined) document.getElementById('enable-2fa').checked = configData.enable2fa;
                        
                        console.log('API设置已加载');
                    }
                } catch (configError) {
                    console.warn('无法获取API设置:', configError);
                    // 继续使用现有数据
                }
                
                // 绑定保存按钮事件(如果未绑定)
                const alreadyBound = document.getElementById('api-settings-bound');
                if (!alreadyBound) {
                    // 标记为已绑定
                    const apiIdInput = document.getElementById('api-id');
                    if (apiIdInput) {
                        // 找到包含此输入框的卡片
                        let parentCard = apiIdInput.closest('.card');
                        if (parentCard) {
                            parentCard.id = 'api-settings-bound';
                        }
                    }
                    
                    console.log('API设置加载完成');
                }
            } catch (error) {
                console.error('加载API设置失败:', error);
                log(`加载API设置失败: ${error.message}`);
            }
        }

        // 确认关闭机器人
        function confirmShutdown() {
            document.getElementById('shutdown-modal').style.display = 'block';
        }

        // 关闭关闭机器人模态框
        function closeShutdownModal() {
            document.getElementById('shutdown-modal').style.display = 'none';
        }

        // 关闭机器人
        async function shutdownBot() {
            try {
                console.log('正在关闭机器人...');
                const result = await makeRequest('shutdownBot');
                
                if (result.success) {
                    console.log('机器人关闭成功:', result);
                    closeShutdownModal();
                    alert('机器人已成功关闭: ' + result.message);
                    
                    // 等待3秒后刷新页面
                    setTimeout(() => {
                        console.log('关闭后自动刷新页面');
                        loadDashboardData(); // 刷新仪表盘数据以更新机器人状态
                    }, 3000);
                } else {
                    console.error('机器人关闭失败:', result.error);
                    closeShutdownModal();
                    alert(`关闭失败: ${result.error}`);
                }
            } catch (error) {
                console.error('关闭机器人请求失败:', error);
                log(`关闭机器人失败: ${error.message}`);
                closeShutdownModal();
                alert(`操作失败: ${error.message}`);
            }
        }
    </script>
</body>
</html>
